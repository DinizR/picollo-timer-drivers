package nz.co.spark.cg.social.extractor.task;

import nz.co.spark.cg.shared.model.ContactType;
import nz.co.spark.cg.shared.sql.SQLUtils;
import nz.co.spark.cg.shared.xml.XmlDomUtils;
import org.cobra.config.api.ConfigurationException;
import org.cobra.timer.model.TriggerType;
import org.junit.After;
import org.junit.Before;
import org.junit.Test;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.File;
import java.io.StringReader;
import java.sql.*;
import java.time.LocalDateTime;
import java.time.ZoneOffset;
import java.time.ZonedDateTime;
import java.time.format.DateTimeFormatter;

import static org.junit.Assert.assertEquals;
import static org.junit.Assert.assertTrue;

public class SocialExtractorTimerTest {
    private static final Logger log = LoggerFactory.getLogger(SocialExtractorTimerTest.class);
    private SocialExtractorTimer socialExtractorTimer;
    private static final String DATABASE_DRIVER = "database.driver";
    private static final String DATABASE_URL = "database.url";
    private static final String DATABASE_USER = "database.user";
    private static final String DATABASE_PASSWORD = "database.password";

    private LocalDateTime now;
    private LocalDateTime less1Min;
    private LocalDateTime less15Min;

    private Connection remoteMemConnection = null;
    private Connection localMemConnection = null;

    public SocialExtractorTimerTest() throws ConfigurationException {
        super();
        socialExtractorTimer = new SocialExtractorTimer();
        now = ZonedDateTime.now(ZoneOffset.UTC).toLocalDateTime();
        less1Min = now.minusMinutes(1);
        less15Min = now.minusMinutes(15);
    }

    @Before
    public void setup() throws SQLException, ClassNotFoundException {
        System.out.println("Starting tests...");
        localMemConnection = createLocalDB();
        createPseudoOracleDB();
    }

    @Test
    public void checkTimerConfig() {
        assertEquals(socialExtractorTimer.getTriggerType(), TriggerType.CRON_EXPRESSION_TRIGGER);
        assertEquals(socialExtractorTimer.cronExpression(),"0 0/1 * ? * * *");
        assertEquals(socialExtractorTimer.getJobClass(),SocialExtractorJob.class);
        assertTrue(socialExtractorTimer.isConfigEnabled());
        assertEquals(socialExtractorTimer.getName(),"social-extractor-timer");
    }

    @Test
    public void checkSocialExtractorJob() throws SQLException {
        SocialExtractorJob socialExtractorJob = new SocialExtractorJob();
        String sql = "SELECT COUNT(*) FROM interaction WHERE type='Social';";
        String notEndedSql = "SELECT COUNT(*) FROM interaction WHERE type='Social' AND finished=false";
        Statement statement = localMemConnection.createStatement();
        int count = 0;

        socialExtractorJob.execute(null);
        ResultSet resultSet = statement.executeQuery(sql);
        if( resultSet.next() ) {
            count = resultSet.getInt(1);
        }
        assertEquals(count,3);
        statement.close();

        statement = localMemConnection.createStatement();
        resultSet = statement.executeQuery(notEndedSql);
        if( resultSet.next() ) {
            count = resultSet.getInt(1);
        }
        assertEquals(count,2);
    }

    private void createPseudoOracleDB() {
        Statement statement;

        try {
            remoteMemConnection = SQLUtils.getDBConnection(
                SocialExtractorTimer.configMap.get(DATABASE_DRIVER),
                SocialExtractorTimer.configMap.get(DATABASE_URL),
                SocialExtractorTimer.configMap.get(DATABASE_USER),
                SocialExtractorTimer.configMap.get(DATABASE_PASSWORD)
            );
            remoteMemConnection.setAutoCommit(true);
            statement = remoteMemConnection.createStatement();
            statement.execute( "DROP ALL OBJECTS;"+
                    "CREATE TABLE INTERACTION (" +
                    "        ID VARCHAR2(16) NOT NULL," +
                    "        STATUS NUMBER(3) NOT NULL," +
                    "        ENTITYTYPEID NUMBER(3) NOT NULL," +
                    "        MEDIATYPEID NVARCHAR2(32) NOT NULL," +
                    "        TYPEID NVARCHAR2(32) NOT NULL," +
                    "        SUBTYPEID NVARCHAR2(32)," +
                    "        EXTERNALID NVARCHAR2(256)," +
                    "        OWNERID NUMBER(10)," +
                    "        CONTACTID VARCHAR2(16)," +
                    "        PARENTID VARCHAR2(16)," +
                    "        STARTDATE DATE NOT NULL," +
                    "        ENDDATE DATE," +
                    "        THREADID VARCHAR2(16)," +
                    "        CATEGORYID VARCHAR2(16)," +
                    "        TIMESHIFT NUMBER(5)," +
                    "        SUBJECT NVARCHAR2(512)," +
                    "        TEXT CLOB," +
                    "        STRUCTUREDTEXT CLOB," +
                    "        STRUCTTEXTMIMETYPE VARCHAR2(256)," +
                    "        THECOMMENT CLOB," +
                    "        TENANTID NUMBER(10) NOT NULL," +
                    "        THREADHASH NUMBER(10)," +
                    "        CANBEPARENT NUMBER(1) NOT NULL," +
                    "        CREATORAPPID NUMBER(10) NOT NULL," +
                    "        QUEUENAME NVARCHAR2(64)," +
                    "        ALLATTRIBUTES BLOB," +
                    "        STRATTRIBUTE1 NVARCHAR2(256)," +
                    "        STRATTRIBUTE2 NVARCHAR2(256)," +
                    "        STRATTRIBUTE3 NVARCHAR2(256)," +
                    "        STRATTRIBUTE4 NVARCHAR2(256)," +
                    "        STRATTRIBUTE5 NVARCHAR2(256)," +
                    "        STRATTRIBUTE6 NVARCHAR2(256)," +
                    "        STRATTRIBUTE7 NVARCHAR2(256)," +
                    "        STRATTRIBUTE8 NVARCHAR2(256)," +
                    "        STRATTRIBUTE9 NVARCHAR2(256)," +
                    "        STRATTRIBUTE10 NVARCHAR2(256)," +
                    "        INTATTRIBUTE1 NUMBER(10)," +
                    "        INTATTRIBUTE2 NUMBER(10)," +
                    "        INTATTRIBUTE3 NUMBER(10)," +
                    "        INTATTRIBUTE4 NUMBER(10)," +
                    "        INTATTRIBUTE5 NUMBER(10)," +
                    "        ISSPAM NUMBER(1)," +
                    "        WEBSAFEEMAILSTATUS NVARCHAR2(32)," +
                    "        ISCATEGORYAPPROVED NUMBER(1)," +
                    "        STOPPEDREASON NVARCHAR2(64)," +
                    "        LANG VARCHAR2(64)," +
                    "        MODIFIEDDATE DATE," +
                    "        SUBTENANTID NUMBER(10)," +
                    "        CONSTRAINT PK_INTERACTION PRIMARY KEY (ID)" +
                    "    );");

            statement.execute(script());
        } catch (SQLException | ClassNotFoundException e) {
            e.printStackTrace();
            log.error("Error creating new db, message:{}",e.getMessage());
        }
    }

    private void createLocalMockDataWithNonFinishedConversation() throws SQLException {
        PreparedStatement statement;

        statement = localMemConnection.prepareStatement("INSERT INTO interaction(id,type,startdate,enddate,xml,finished) VALUES (?,?,?,?,?,?)");
        statement.setString(1,"00027aDEQEY00TYB");
        statement.setString(2, ContactType.Social.toString());
        statement.setTimestamp(3,Timestamp.valueOf(less15Min.plusMinutes(720)));
        statement.setTimestamp(4,Timestamp.valueOf(less15Min.plusMinutes(720+5)));
        String clob = "<?xml version=\"1.0\"?><chatTranscript startAt=\"2018-08-01T21:36:59Z\" sessionId=\"0002EaDCW2B202E9\"><newParty userId=\"00E55B6227FB011C\" timeShift=\"1\" visibility=\"ALL\" eventId=\"1\"><userInfo personId=\"\" userNick=\"Angus Huckle\" userType=\"CLIENT\" protocolType=\"FLEX\" timeZoneOffset=\"720\"/><userData><item key=\"Bot\" type=\"string\">true</item><item key=\"ChatBotHoldup\" type=\"string\">true</item><item key=\"ChatBotID\" type=\"string\">EchoBot</item><item key=\"ChatBotName\" type=\"string\">Edgar</item><item key=\"EmailAddress\" type=\"string\">angus.huckle@spark.co.nz</item><item key=\"FirstName\" type=\"string\">Angus</item><item key=\"IdentifyCreateContact\" type=\"string\">3</item><item key=\"LastName\" type=\"string\">Huckle</item><item key=\"MediaType\" type=\"string\">chat</item><item key=\"StopBotOnAgentArrival\" type=\"string\">false</item><item key=\"StopBotOnCustomerLeft\" type=\"string\">false</item><item key=\"TimeZone\" type=\"string\">720</item><item key=\"Visibility\" type=\"string\">ALL</item><item key=\"_genesys_OS\" type=\"string\">Windows</item><item key=\"_genesys_browser\" type=\"string\">Firefox</item><item key=\"_genesys_pageTitle\" type=\"string\">Widgets Project</item><item key=\"_genesys_referrer\" type=\"string\"/><item key=\"_genesys_source\" type=\"string\">web</item><item key=\"_genesys_url\" type=\"string\">file:///C:/Logs/gEcho/Widgets/launcher.html</item><item key=\"email\" type=\"string\">angus.huckle@spark.co.nz</item><item key=\"firstname\" type=\"string\">Angus</item><item key=\"lastname\" type=\"string\">Huckle</item><item key=\"subject\" type=\"string\">I want to pay my bill</item></userData></newParty><newParty userId=\"00E55B6227FF011E\" timeShift=\"4\" visibility=\"ALL\" eventId=\"2\"><userInfo personId=\"\" userNick=\"Spark\" userType=\"EXTERNAL\" protocolType=\"ESP\" timeZoneOffset=\"0\"/></newParty><message userId=\"00E55B6227FF011E\" timeShift=\"4\" visibility=\"ALL\" eventId=\"3\"><msgText>Workflow starts the bot: </msgText></message><newParty userId=\"00E55B6227FF011F\" timeShift=\"4\" visibility=\"ALL\" eventId=\"4\"><userInfo personId=\"\" userNick=\"GInA\" userType=\"AGENT\" protocolType=\"BASIC\" timeZoneOffset=\"43200000\"/><userData><item key=\"GCTI_Chat_SetPartyStyle\" type=\"string\">BOT</item></userData></newParty><message userId=\"00E55B6227FF011F\" timeShift=\"5\" visibility=\"ALL\" eventId=\"5\"><msgText msgType=\"text/plain\">Hi, I&apos;m GInA, your Virtual Assistant.</msgText></message><message userId=\"00E55B6227FF011F\" timeShift=\"5\" visibility=\"ALL\" eventId=\"6\"><msgText msgType=\"text/plain\">How can I help you?</msgText></message><message userId=\"00E55B6227FF011E\" timeShift=\"6\" visibility=\"ALL\" eventId=\"7\"><msgText>Workflow is running in waiting mode</msgText></message><message userId=\"00E55B6227FB011C\" timeShift=\"15\" visibility=\"ALL\" eventId=\"9\"><msgText msgType=\"text\">pay bill</msgText></message><message userId=\"00E55B6227FF011F\" timeShift=\"17\" visibility=\"ALL\" eventId=\"11\"><msgText msgType=\"text/plain\">Oooo. Pay your bell, eh? Now where&apos;s that MicroApp.... </msgText></message><message userId=\"00E55B6227FF011F\" timeShift=\"17\" visibility=\"ALL\" eventId=\"12\"><msgText msgType=\"text/plain\">I&apos;m trying to find my MicroApp.... But it&apos;s not there.</msgText></message><message userId=\"00E55B6227FF011F\" timeShift=\"17\" visibility=\"ALL\" eventId=\"13\"><msgText msgType=\"text/plain\"> My human colleagues are available to talk to you, theyre really busy at the moment so the wait time may be longer than usual. Select Connect to Live Chat to get started.&lt;br&gt;&lt;ul class=&quot;gwc-action-list&quot;&gt;&lt;li class=&quot;gwc-action-item&quot;&gt;&lt;a href=&quot;#&quot; class=&quot;gwc-action-text&quot; id=&quot;6a0c3d32-67cb-48d8-92a4-a1846174bb75&quot;&gt;Connect to Live Chat&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;</msgText></message><message userId=\"00E55B6227FF011F\" timeShift=\"17\" visibility=\"ALL\" eventId=\"14\"><msgText msgType=\"text/plain\">Is there anything else I can help you with?</msgText></message><message userId=\"00E55B6227FB011C\" timeShift=\"20\" visibility=\"ALL\" eventId=\"15\"><msgText msgType=\"text\">advisor</msgText></message><message userId=\"00E55B6227FF011F\" timeShift=\"20\" visibility=\"ALL\" eventId=\"16\"><msgText msgType=\"text/plain\">One moment please while I connect you.</msgText></message><partyLeft userId=\"00E55B6227FF011F\" timeShift=\"21\" visibility=\"ALL\" eventId=\"17\" askerId=\"00E55B6227FF011F\"><reason>left</reason></partyLeft><message userId=\"00E55B6227FF011E\" timeShift=\"24\" visibility=\"ALL\" eventId=\"18\"><msgText>Chat bot finished successfully</msgText></message><newParty userId=\"00E55B4FED7D004C\" timeShift=\"28\" visibility=\"ALL\" eventId=\"19\"><userInfo personId=\"\" userNick=\"Spark\" userType=\"AGENT\" protocolType=\"BASIC\" timeZoneOffset=\"0\"/></newParty><message userId=\"00E55B6227FB011C\" timeShift=\"35\" visibility=\"ALL\" eventId=\"21\"><msgText msgType=\"text\">hello</msgText></message><message userId=\"00E55B4FED7D004C\" timeShift=\"35\" visibility=\"ALL\" eventId=\"22\"><msgText>Kia ora! How can I help you today?</msgText></message><notice userId=\"00E55B4FED7D004C\" timeShift=\"35\" visibility=\"ALL\" eventId=\"23\"><noticeText noticeType=\"USER_CUSTOM\">Kia ora! How can I help you today?</noticeText></notice><message userId=\"00E55B6227FB011C\" timeShift=\"37\" visibility=\"ALL\" eventId=\"25\"><msgText msgType=\"text\">bye</msgText></message><message userId=\"00E55B4FED7D004C\" timeShift=\"37\" visibility=\"ALL\" eventId=\"26\"><msgText>Haere rā<U+200B>!</msgText></message><notice userId=\"00E55B4FED7D004C\" timeShift=\"37\" visibility=\"ALL\" eventId=\"27\"><noticeText noticeType=\"USER_CUSTOM\">Haere rā<U+200B>!</noticeText></notice><partyLeft userId=\"00E55B6227FB011C\" timeShift=\"45\" visibility=\"ALL\" eventId=\"28\" askerId=\"00E55B6227FB011C\"><reason>left</reason></partyLeft><partyLeft userId=\"00E55B4FED7D004C\" timeShift=\"45\" visibility=\"ALL\" eventId=\"29\" askerId=\"00E55B4FED7D004C\"><reason>left</reason></partyLeft></chatTranscript>";
        statement.setClob(5,new StringReader(clob),clob.length() );
        statement.setBoolean(6,false);
        statement.executeUpdate();
    }

    private String script() {
        LocalDateTime less30Min = now.minusMinutes(30);
        LocalDateTime less45Min = now.minusMinutes(45);
        LocalDateTime less1Hour = now.minusHours(1);
        LocalDateTime less1Day = now.minusDays(1);
        DateTimeFormatter formatter = DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss");

        return "INSERT INTO INTERACTION (ID, STATUS, ENTITYTYPEID, MEDIATYPEID, TYPEID, SUBTYPEID, EXTERNALID, OWNERID, CONTACTID, PARENTID, STARTDATE, ENDDATE, THREADID, CATEGORYID, TIMESHIFT, SUBJECT, TEXT, STRUCTUREDTEXT, STRUCTTEXTMIMETYPE, THECOMMENT, TENANTID, THREADHASH, CANBEPARENT, CREATORAPPID, QUEUENAME, STRATTRIBUTE1, STRATTRIBUTE2, STRATTRIBUTE3, STRATTRIBUTE4, STRATTRIBUTE5, STRATTRIBUTE6, STRATTRIBUTE7, STRATTRIBUTE8, STRATTRIBUTE9, STRATTRIBUTE10, INTATTRIBUTE1, INTATTRIBUTE2, INTATTRIBUTE3, INTATTRIBUTE4, INTATTRIBUTE5, ISSPAM, WEBSAFEEMAILSTATUS, ISCATEGORYAPPROVED, STOPPEDREASON, LANG, MODIFIEDDATE, SUBTENANTID) VALUES ('00027aDEQEY00U32', 3, 2, 'facebooksession', 'Inbound', 'InboundNew', '02BD5B88B2A61A95', 2966, '0001UaCD608W0CFA', null, TIMESTAMP '"+
                less1Min.format(formatter)+"', TIMESTAMP '"+less1Min.plusMinutes(5).format(formatter)+"', '00027aDEQEY00U36', null, 720, ' - Spark Ref: 180831-100011', null, '<?xml version=\"1.0\"?><chatTranscript startAt=\"2018-08-31T03:14:46Z\" sessionId=\"00027aDEQEY00U32\"><newParty userId=\"02BD5B88B2A61A94\" timeShift=\"0\" visibility=\"ALL\" eventId=\"1\"><userInfo personId=\"\" userNick=\"Spark Customer\" userType=\"CLIENT\" protocolType=\"FLEX\" timeZoneOffset=\"0\"/><userData><item key=\"BroadbandDiagnosticJourney\"></item><item key=\"BroadbandDiagnosticServiceID\"></item><item key=\"ConnectionID\">02c702bea8325366</item><item key=\"FirstName\">Spark</item><item key=\"GCTI_LanguageCode\">en-NZ</item><item key=\"IPaddress\">10.235.8.19</item><item key=\"IdentifyCreateContact\">3</item><item key=\"LastName\">Customer</item><item key=\"MediaType\">chat</item><item key=\"PageTag\">PersonalContactUs</item><item key=\"TimeZone\">780</item><item key=\"UserAgent\">Mozilla/5.0 (Windows NT 10.0; WOW64; rv:52.0) Gecko/20100101 Firefox/52.0</item><item key=\"VHQueue\"></item><item key=\"_genesys_pageTitle\">Contact us | Spark NZ</item><item key=\"_genesys_referrer\"></item><item key=\"_genesys_source\">web</item><item key=\"_genesys_url\">https://www-staging.spark.co.nz/contactus/</item></userData></newParty><newParty userId=\"02BD5B7CDBA71995\" timeShift=\"5\" visibility=\"ALL\" eventId=\"2\"><userInfo personId=\"\" userNick=\"Spark&apos;s Virtual Assistant\" userType=\"AGENT\" protocolType=\"BASIC\" timeZoneOffset=\"0\"/></newParty><message userId=\"02BD5B7CDBA71995\" timeShift=\"6\" visibility=\"ALL\" eventId=\"3\"><msgText>Hi, I&apos;m Spark&apos;s chat bot! You can ask me questions like &quot;how do I find my account number&quot; or &quot;how do I set up Netflix&quot;. </msgText></message><notice userId=\"02BD5B7CDBA71995\" timeShift=\"6\" visibility=\"ALL\" eventId=\"4\"><noticeText noticeType=\"USER_CUSTOM\">Hi, I&apos;m Spark&apos;s chat bot! You can ask me questions like &quot;how do I find my account number&quot; or &quot;how do I set up Netflix&quot;. </noticeText></notice><message userId=\"02BD5B7CDBA71995\" timeShift=\"6\" visibility=\"ALL\" eventId=\"5\"><msgText>If we get stuck, I can get you through to the team on Live Chat.</msgText></message><notice userId=\"02BD5B7CDBA71995\" timeShift=\"6\" visibility=\"ALL\" eventId=\"6\"><noticeText noticeType=\"USER_CUSTOM\">If we get stuck, I can get you through to the team on Live Chat.</noticeText></notice><message userId=\"02BD5B88B2A61A94\" timeShift=\"22\" visibility=\"ALL\" eventId=\"8\"><msgText msgType=\"text\">hey spark how do i set up netflix</msgText></message><message userId=\"02BD5B7CDBA71995\" timeShift=\"23\" visibility=\"ALL\" eventId=\"9\"><msgText>To get Netflix on us, sign in to MySpark using the link I&apos;ve provided. You&apos;ll see the options available for you. If you&apos;re already eligible for Netflix, follow the instructions to get set up." +
                "" +
                "    If you pay for Netflix currently, Get started with Netflix has some handy info. More Information:" +
                "    Manage Netflix in MySpark - https://www-staging.spark.co.nz/secure/myspark/netflix" +
                "    Get started with Netflix - https://www-staging.spark.co.nz/help/get-more/netflix/set-up-netflix/</msgText></message><notice userId=\"02BD5B7CDBA71995\" timeShift=\"23\" visibility=\"ALL\" eventId=\"10\"><noticeText noticeType=\"USER_CUSTOM\">To get Netflix on us, sign in to MySpark using the link I&apos;ve provided. You&apos;ll see the options available for you. If you&apos;re already eligible for Netflix, follow the instructions to get set up." +
                "" +
                "    If you pay for Netflix currently, Get started with Netflix has some handy info.&lt;br&gt;&lt;ul class=&quot;gwc-action-list&quot;&gt;&lt;li class=&quot;gwc-action-item&quot;&gt;&lt;a href=&quot;https://www-staging.spark.co.nz/secure/myspark/netflix&quot; title=&quot;Manage Netflix in MySpark&quot; target=&quot;_blank&quot; id=&quot;b0e26d35-ce1b-4bdc-afd4-0e0a61960c60&quot;&gt;Manage Netflix in MySpark&lt;/a&gt;&lt;/li&gt;&lt;li class=&quot;gwc-action-item&quot;&gt;&lt;a href=&quot;https://www-staging.spark.co.nz/help/get-more/netflix/set-up-netflix/&quot; title=&quot;Get started with Netflix&quot; target=&quot;_blank&quot; id=&quot;b0e26d35-ce1b-4bdc-afd4-0e0a61960c60&quot;&gt;Get started with Netflix&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;</noticeText></notice><message userId=\"02BD5B88B2A61A94\" timeShift=\"29\" visibility=\"ALL\" eventId=\"12\"><msgText msgType=\"text\">that didnt work</msgText></message><message userId=\"02BD5B7CDBA71995\" timeShift=\"31\" visibility=\"ALL\" eventId=\"13\"><msgText>I&apos;m sorry, I&apos;m not sure what you&apos;re asking me. \uD83D\uDE41 Have a go at rephrasing your question or using different words. You can also type: human please if you&apos;d like to talk to one of my human colleagues.</msgText></message><notice userId=\"02BD5B7CDBA71995\" timeShift=\"31\" visibility=\"ALL\" eventId=\"14\"><noticeText noticeType=\"USER_CUSTOM\">I&apos;m sorry, I&apos;m not sure what you&apos;re asking me. \uD83D\uDE41 Have a go at rephrasing your question or using different words. You can also type: human please if you&apos;d like to talk to one of my human colleagues.</noticeText></notice><message userId=\"02BD5B88B2A61A94\" timeShift=\"37\" visibility=\"ALL\" eventId=\"16\"><msgText msgType=\"text\">can i talk to a human</msgText></message><message userId=\"02BD5B7CDBA71995\" timeShift=\"39\" visibility=\"ALL\" eventId=\"17\"><msgText>My human colleagues are available to talk to you, they&apos;re really busy at the moment so the wait time may be longer than usual. Select Connect to Live Chat to get started. More Information:" +
                "    Connect to Live Chat</msgText></message><notice userId=\"02BD5B7CDBA71995\" timeShift=\"39\" visibility=\"ALL\" eventId=\"18\"><noticeText noticeType=\"USER_CUSTOM\">My human colleagues are available to talk to you, they&apos;re really busy at the moment so the wait time may be longer than usual. Select Connect to Live Chat to get started.&lt;br&gt;&lt;ul class=&quot;gwc-action-list&quot;&gt;&lt;li class=&quot;gwc-action-item&quot;&gt;&lt;a href=&quot;#&quot; class=&quot;gwc-action-text&quot; id=&quot;6a0c3d32-67cb-48d8-92a4-a1846174bb75&quot;&gt;Connect to Live Chat&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;</noticeText></notice><message userId=\"02BD5B88B2A61A94\" timeShift=\"42\" visibility=\"ALL\" eventId=\"19\"><msgText msgType=\"text\">Connect to Live Chat</msgText></message><message userId=\"02BD5B7CDBA71995\" timeShift=\"44\" visibility=\"ALL\" eventId=\"20\"><msgText>Someone should be available to help you in less than a minute.</msgText></message><notice userId=\"02BD5B7CDBA71995\" timeShift=\"44\" visibility=\"ALL\" eventId=\"21\"><noticeText noticeType=\"USER_CUSTOM\">Someone should be available to help you in less than a minute.</noticeText></notice><message userId=\"02BD5B7CDBA71995\" timeShift=\"44\" visibility=\"ALL\" eventId=\"22\"><msgText>Before I transfer you, can you please tell me your name?</msgText></message><notice userId=\"02BD5B7CDBA71995\" timeShift=\"44\" visibility=\"ALL\" eventId=\"23\"><noticeText noticeType=\"USER_CUSTOM\">Before I transfer you, can you please tell me your name?</noticeText></notice><message userId=\"02BD5B88B2A61A94\" timeShift=\"54\" visibility=\"ALL\" eventId=\"25\"><msgText msgType=\"text\">Victoria</msgText></message><message userId=\"02BD5B7CDBA71995\" timeShift=\"54\" visibility=\"ALL\" eventId=\"26\"><msgText>Can I have your email address so I can send you a transcript of our chat?</msgText></message><notice userId=\"02BD5B7CDBA71995\" timeShift=\"54\" visibility=\"ALL\" eventId=\"27\"><noticeText noticeType=\"USER_CUSTOM\">Can I have your email address so I can send you a transcript of our chat?</noticeText></notice><message userId=\"02BD5B88B2A61A94\" timeShift=\"60\" visibility=\"ALL\" eventId=\"29\"><msgText msgType=\"text\">victoria.fitch@spark.co.nz</msgText></message><partyLeft userId=\"02BD5B7CDBA71995\" timeShift=\"60\" visibility=\"ALL\" eventId=\"30\" askerId=\"02BD5B7CDBA71995\"><reason>left</reason></partyLeft><newParty userId=\"02BD5B88B2E51A96\" timeShift=\"63\" visibility=\"ALL\" eventId=\"31\"><userInfo personId=\"\" userNick=\"Spark\" userType=\"EXTERNAL\" protocolType=\"ESP\" timeZoneOffset=\"0\"/></newParty><notice userId=\"02BD5B88B2E51A96\" timeShift=\"63\" visibility=\"ALL\" eventId=\"32\"><noticeText noticeType=\"USER_CUSTOM\">switching from bot to real agent</noticeText></notice><message userId=\"02BD5B88B2E51A96\" timeShift=\"63\" visibility=\"ALL\" eventId=\"33\"><msgText>*#You&apos;re being transferred to the Live Chat team. We estimate someone should be with you in less than a minute.</msgText></message><newParty userId=\"02BD5B88B3131A97\" timeShift=\"109\" visibility=\"ALL\" eventId=\"34\"><userInfo personId=\"9876\" userNick=\"Jesus\" userType=\"AGENT\" protocolType=\"BASIC\" timeZoneOffset=\"720\"/></newParty><message userId=\"02BD5B88B3131A97\" timeShift=\"121\" visibility=\"ALL\" eventId=\"36\"><msgText treatAs=\"NORMAL\">Hi</msgText></message><message userId=\"02BD5B88B3131A97\" timeShift=\"128\" visibility=\"ALL\" eventId=\"38\"><msgText treatAs=\"NORMAL\">so you cant setup netflix</msgText></message><message userId=\"02BD5B88B3131A97\" timeShift=\"134\" visibility=\"ALL\" eventId=\"40\"><msgText treatAs=\"NORMAL\">lets take a look at that</msgText></message><message userId=\"02BD5B88B2A61A94\" timeShift=\"146\" visibility=\"ALL\" eventId=\"42\"><msgText msgType=\"text\">sweet thanks</msgText></message><message userId=\"02BD5B88B3131A97\" timeShift=\"183\" visibility=\"ALL\" eventId=\"44\"><msgText treatAs=\"NORMAL\">so all done - but there looks like there is a problem with your internet ill xfer you to our Resolve guys to take a look</msgText></message><partyLeft userId=\"02BD5B88B3131A97\" timeShift=\"192\" visibility=\"ALL\" eventId=\"45\" askerId=\"02BD5B88B3131A97\"><reason>left</reason></partyLeft><message userId=\"02BD5B88B2E51A96\" timeShift=\"195\" visibility=\"ALL\" eventId=\"46\"><msgText>Transferring. Please wait...</msgText></message><newParty userId=\"02BD5B88B3881A98\" timeShift=\"226\" visibility=\"ALL\" eventId=\"47\"><userInfo personId=\"5330\" userNick=\"Vix\" userType=\"AGENT\" protocolType=\"BASIC\" timeZoneOffset=\"720\"/></newParty><message userId=\"02BD5B88B3881A98\" timeShift=\"249\" visibility=\"ALL\" eventId=\"49\"><msgText treatAs=\"NORMAL\">taking a look at your line now</msgText></message><message userId=\"02BD5B88B3881A98\" timeShift=\"259\" visibility=\"ALL\" eventId=\"51\"><msgText treatAs=\"NORMAL\">hmm i think this can be solved by restarting your modem</msgText></message><message userId=\"02BD5B88B2A61A94\" timeShift=\"267\" visibility=\"ALL\" eventId=\"53\"><msgText msgType=\"text\">for sure - ill do that now</msgText></message><message userId=\"02BD5B88B2A61A94\" timeShift=\"268\" visibility=\"ALL\" eventId=\"55\"><msgText msgType=\"text\">thanks</msgText></message><message userId=\"02BD5B88B3881A98\" timeShift=\"296\" visibility=\"ALL\" eventId=\"60\"><msgText treatAs=\"NORMAL\">welcome </msgText></message><partyLeft userId=\"02BD5B88B3881A98\" timeShift=\"299\" visibility=\"ALL\" eventId=\"61\" askerId=\"02BD5B88B3881A98\"><reason code=\"1\">left with request to close if no agents</reason></partyLeft><partyLeft userId=\"02BD5B88B2A61A94\" timeShift=\"299\" visibility=\"ALL\" eventId=\"62\" askerId=\"02BD5B88B3881A98\"><reason code=\"4\">removed by other party</reason></partyLeft></chatTranscript>', 'text/xml', 'Placed in the queue on 31/08/2018 15:17:58 by t462128 - ', 101, 81630065, 1, 701, null, 'victoria.fitch@spark.co.nz', '180831-100011', null, null, null, 'https://www-staging.spark.co.nz/contactus/', null, null, null, null, null, null, null, null, null, null, null, null, 'Normal', null, null, null);" +
                "    INSERT INTO INTERACTION (ID, STATUS, ENTITYTYPEID, MEDIATYPEID, TYPEID, SUBTYPEID, EXTERNALID, OWNERID, CONTACTID, PARENTID, STARTDATE, ENDDATE, THREADID, CATEGORYID, TIMESHIFT, SUBJECT, TEXT, STRUCTUREDTEXT, STRUCTTEXTMIMETYPE, THECOMMENT, TENANTID, THREADHASH, CANBEPARENT, CREATORAPPID, QUEUENAME, STRATTRIBUTE1, STRATTRIBUTE2, STRATTRIBUTE3, STRATTRIBUTE4, STRATTRIBUTE5, STRATTRIBUTE6, STRATTRIBUTE7, STRATTRIBUTE8, STRATTRIBUTE9, STRATTRIBUTE10, INTATTRIBUTE1, INTATTRIBUTE2, INTATTRIBUTE3, INTATTRIBUTE4, INTATTRIBUTE5, ISSPAM, WEBSAFEEMAILSTATUS, ISCATEGORYAPPROVED, STOPPEDREASON, LANG, MODIFIEDDATE, SUBTENANTID) VALUES ('00027aDEQEY00TYB', 3, 2, 'chat', 'Inbound', 'InboundNew', '02BD5B874F401A58', 3159, '0001CaAV5KUW828W', null, TIMESTAMP '"+
                less15Min.format(formatter)+"', TIMESTAMP '"+less15Min.plusMinutes(10).format(formatter)+"', '00027aDEQEY00TYF', null, 720, ' - Spark Ref: 180830-100013', null, '<?xml version=\"1.0\"?><chatTranscript startAt=\"2018-08-30T01:58:24Z\" sessionId=\"00027aDEQEY00TYD\"><newParty userId=\"02BD5B874F401A57\" timeShift=\"0\" visibility=\"ALL\" eventId=\"1\"><userInfo personId=\"\" userNick=\"Spark Customer\" userType=\"CLIENT\" protocolType=\"FLEX\" timeZoneOffset=\"0\"/><userData><item key=\"BroadbandDiagnosticJourney\"></item><item key=\"BroadbandDiagnosticServiceID\"></item><item key=\"ConnectionID\">02c702bea83248ed</item><item key=\"FirstName\">Spark</item><item key=\"GCTI_LanguageCode\">en-NZ</item><item key=\"IPaddress\">10.235.8.19</item><item key=\"IdentifyCreateContact\">3</item><item key=\"LastName\">Customer</item><item key=\"MediaType\">chat</item><item key=\"PageTag\">SparkApp</item><item key=\"TimeZone\">780</item><item key=\"UserAgent\">Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/68.0.3440.106 Safari/537.36</item><item key=\"VHQueue\"></item><item key=\"_genesys_pageTitle\">Chat With Us | Spark NZ</item><item key=\"_genesys_referrer\"></item><item key=\"_genesys_source\">web</item><item key=\"_genesys_url\">https://www-int03.spark.co.nz/help/app-chat/</item></userData></newParty><newParty userId=\"02BD5B7CDBA71995\" timeShift=\"4\" visibility=\"ALL\" eventId=\"2\"><userInfo personId=\"\" userNick=\"Spark&apos;s Virtual Assistant\" userType=\"AGENT\" protocolType=\"BASIC\" timeZoneOffset=\"0\"/></newParty><message userId=\"02BD5B7CDBA71995\" timeShift=\"5\" visibility=\"ALL\" eventId=\"3\"><msgText>Hi there, welcome back! How can I help?</msgText></message><notice userId=\"02BD5B7CDBA71995\" timeShift=\"5\" visibility=\"ALL\" eventId=\"4\"><noticeText noticeType=\"USER_CUSTOM\">Hi there, welcome back! How can I help?</noticeText></notice><message userId=\"02BD5B874F401A57\" timeShift=\"25\" visibility=\"ALL\" eventId=\"9\"><msgText msgType=\"text\">human</msgText></message><message userId=\"02BD5B7CDBA71995\" timeShift=\"27\" visibility=\"ALL\" eventId=\"10\"><msgText>My human colleagues are available to talk to you, they&apos;re really busy at the moment so the wait time may be longer than usual. Select Connect to Live Chat to get started. More Information:" +
                "    Connect to Live Chat</msgText></message><notice userId=\"02BD5B7CDBA71995\" timeShift=\"27\" visibility=\"ALL\" eventId=\"11\"><noticeText noticeType=\"USER_CUSTOM\">My human colleagues are available to talk to you, they&apos;re really busy at the moment so the wait time may be longer than usual. Select Connect to Live Chat to get started.&lt;br&gt;&lt;ul class=&quot;gwc-action-list&quot;&gt;&lt;li class=&quot;gwc-action-item&quot;&gt;&lt;a href=&quot;#&quot; class=&quot;gwc-action-text&quot; id=&quot;6a0c3d32-67cb-48d8-92a4-a1846174bb75&quot;&gt;Connect to Live Chat&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;</noticeText></notice><message userId=\"02BD5B874F401A57\" timeShift=\"35\" visibility=\"ALL\" eventId=\"12\"><msgText msgType=\"text\">Connect to Live Chat</msgText></message><message userId=\"02BD5B7CDBA71995\" timeShift=\"36\" visibility=\"ALL\" eventId=\"13\"><msgText>Someone should be available to help you in less than a minute.</msgText></message><notice userId=\"02BD5B7CDBA71995\" timeShift=\"36\" visibility=\"ALL\" eventId=\"14\"><noticeText noticeType=\"USER_CUSTOM\">Someone should be available to help you in less than a minute.</noticeText></notice><message userId=\"02BD5B7CDBA71995\" timeShift=\"37\" visibility=\"ALL\" eventId=\"15\"><msgText>Before I transfer you, can you please tell me your name?</msgText></message><notice userId=\"02BD5B7CDBA71995\" timeShift=\"37\" visibility=\"ALL\" eventId=\"16\"><noticeText noticeType=\"USER_CUSTOM\">Before I transfer you, can you please tell me your name?</noticeText></notice><message userId=\"02BD5B874F401A57\" timeShift=\"46\" visibility=\"ALL\" eventId=\"18\"><msgText msgType=\"text\">test</msgText></message><message userId=\"02BD5B7CDBA71995\" timeShift=\"46\" visibility=\"ALL\" eventId=\"19\"><msgText>Can I have your email address so I can send you a transcript of our chat?</msgText></message><notice userId=\"02BD5B7CDBA71995\" timeShift=\"46\" visibility=\"ALL\" eventId=\"20\"><noticeText noticeType=\"USER_CUSTOM\">Can I have your email address so I can send you a transcript of our chat?</noticeText></notice><message userId=\"02BD5B874F401A57\" timeShift=\"54\" visibility=\"ALL\" eventId=\"22\"><msgText msgType=\"text\">test@spark.co.nz</msgText></message><partyLeft userId=\"02BD5B7CDBA71995\" timeShift=\"54\" visibility=\"ALL\" eventId=\"23\" askerId=\"02BD5B7CDBA71995\"><reason>left</reason></partyLeft><newParty userId=\"02BD5B874F781A59\" timeShift=\"56\" visibility=\"ALL\" eventId=\"24\"><userInfo personId=\"\" userNick=\"Spark\" userType=\"EXTERNAL\" protocolType=\"ESP\" timeZoneOffset=\"0\"/></newParty><notice userId=\"02BD5B874F781A59\" timeShift=\"56\" visibility=\"ALL\" eventId=\"25\"><noticeText noticeType=\"USER_CUSTOM\">switching from bot to real agent</noticeText></notice><message userId=\"02BD5B874F781A59\" timeShift=\"56\" visibility=\"ALL\" eventId=\"26\"><msgText>*#You&apos;re being transferred to the Live Chat team. We estimate someone should be with you in less than a minute.</msgText></message><newParty userId=\"02BD5B874FA51A5A\" timeShift=\"101\" visibility=\"ALL\" eventId=\"29\"><userInfo personId=\"t805645\" userNick=\"Eddie\" userType=\"AGENT\" protocolType=\"BASIC\" timeZoneOffset=\"720\"/></newParty><partyLeft userId=\"02BD5B874F401A57\" timeShift=\"270\" visibility=\"ALL\" eventId=\"32\" askerId=\"02BD5B874F401A57\"><reason>left</reason></partyLeft><partyLeft userId=\"02BD5B874FA51A5A\" timeShift=\"3966\" visibility=\"ALL\" eventId=\"33\" askerId=\"02BD5B874FA51A5A\"><reason code=\"1\">left with request to close if no agents</reason></partyLeft></chatTranscript>', 'text/xml', ' ', 101, 81629955, 1, 701, null, 'test@spark.co.nz', '180830-100013', null, null, null, 'https://www-int03.spark.co.nz/help/app-chat/', null, null, null, null, null, null, null, null, null, null, null, null, 'Normal', null, null, null);" +
                "    INSERT INTO INTERACTION (ID, STATUS, ENTITYTYPEID, MEDIATYPEID, TYPEID, SUBTYPEID, EXTERNALID, OWNERID, CONTACTID, PARENTID, STARTDATE, ENDDATE, THREADID, CATEGORYID, TIMESHIFT, SUBJECT, TEXT, STRUCTUREDTEXT, STRUCTTEXTMIMETYPE, THECOMMENT, TENANTID, THREADHASH, CANBEPARENT, CREATORAPPID, QUEUENAME, STRATTRIBUTE1, STRATTRIBUTE2, STRATTRIBUTE3, STRATTRIBUTE4, STRATTRIBUTE5, STRATTRIBUTE6, STRATTRIBUTE7, STRATTRIBUTE8, STRATTRIBUTE9, STRATTRIBUTE10, INTATTRIBUTE1, INTATTRIBUTE2, INTATTRIBUTE3, INTATTRIBUTE4, INTATTRIBUTE5, ISSPAM, WEBSAFEEMAILSTATUS, ISCATEGORYAPPROVED, STOPPEDREASON, LANG, MODIFIEDDATE, SUBTENANTID) VALUES ('00027aDEQEY00TVK', 3, 2, 'facebooksession', 'Inbound', 'InboundNew', '02BD5B861C6F1A26', 3159, '0001UaCD608W08XJ', null, TIMESTAMP '"+
                less30Min.format(formatter)+"', TIMESTAMP '"+less30Min.plusMinutes(10).format(formatter)+"', '00027aDEQEY00TVM', null, 720, ' - Spark Ref: 180829-100017', null, '<?xml version=\"1.0\"?><chatTranscript startAt=\"2018-08-29T04:09:19Z\" sessionId=\"00027aDEQEY00TVK\"><newParty userId=\"02BD5B861C6E1A25\" timeShift=\"0\" visibility=\"ALL\" eventId=\"1\"><userInfo personId=\"\" userNick=\"test test\" userType=\"CLIENT\" protocolType=\"FLEX\" timeZoneOffset=\"0\"/><userData><item key=\"BroadbandDiagnosticJourney\"></item><item key=\"BroadbandDiagnosticServiceID\"></item><item key=\"ConnectionID\">02c702bea832424a</item><item key=\"FirstName\">test</item><item key=\"GCTI_LanguageCode\">en-NZ</item><item key=\"IPaddress\">10.235.8.19</item><item key=\"IdentifyCreateContact\">3</item><item key=\"LastName\">test</item><item key=\"MediaType\">chat</item><item key=\"PageTag\">HelpXtra</item><item key=\"TimeZone\">780</item><item key=\"UserAgent\">Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/68.0.3440.106 Safari/537.36</item><item key=\"VHQueue\"></item><item key=\"_genesys_pageTitle\">Can&apos;t receive email | Spark NZ</item><item key=\"_genesys_referrer\"></item><item key=\"_genesys_source\">web</item><item key=\"_genesys_url\">https://www-int03.spark.co.nz/help/get-more/xtra-troubleshooting/cant-receive-email/</item></userData></newParty><newParty userId=\"02BD5B861C761A27\" timeShift=\"7\" visibility=\"ALL\" eventId=\"2\"><userInfo personId=\"\" userNick=\"Spark\" userType=\"EXTERNAL\" protocolType=\"ESP\" timeZoneOffset=\"0\"/></newParty><message userId=\"02BD5B861C761A27\" timeShift=\"7\" visibility=\"ALL\" eventId=\"3\"><msgText>Xtra troubleshooting details" +
                "    Question - How are you trying to access your Xtra Mail?" +
                "    Customer chose - I use Webmail (xtramail.co.nz)" +
                "    Question - To see if your account is working, try signing in to Webmail with your email address and password at xtramail.co.nz" +
                "" +
                "" +
                "    Did it work?" +
                "    Customer chose - No" +
                "    Question - There may be a problem with your internet connection. On the device you&apos;re trying access your Xtra Mail with, can you open other websites such as google.co.nz?" +
                "    Customer chose - Yes" +
                "    Question - Ah, your internet is working so there may be another problem. What&apos;s happening?" +
                "    Customer chose - Something else is happening." +
                "    Question - There may be an outage, but it hasn&apos;t been reported yet. Or there could be a problem with your modem. What would you like to do?" +
                "    Customer chose - I&apos;d like to contact Spark by Live Chat.</msgText></message><message userId=\"02BD5B861C761A27\" timeShift=\"7\" visibility=\"ALL\" eventId=\"4\"><msgText>My email address: </msgText></message><message userId=\"02BD5B861C761A27\" timeShift=\"7\" visibility=\"ALL\" eventId=\"5\"><msgText>My question: </msgText></message><message userId=\"02BD5B861C761A27\" timeShift=\"27\" visibility=\"ALL\" eventId=\"6\"><msgText>Someone should be available to help you in less than a minute.</msgText></message><newParty userId=\"02BD5B861C8F1A28\" timeShift=\"32\" visibility=\"ALL\" eventId=\"7\"><userInfo personId=\"t805645\" userNick=\"Eddie\" userType=\"AGENT\" protocolType=\"BASIC\" timeZoneOffset=\"720\"/></newParty><partyLeft userId=\"02BD5B861C6E1A25\" timeShift=\"46\" visibility=\"ALL\" eventId=\"8\" askerId=\"02BD5B861C6E1A25\"><reason>left</reason></partyLeft><partyLeft userId=\"02BD5B861C8F1A28\" timeShift=\"62\" visibility=\"ALL\" eventId=\"9\" askerId=\"02BD5B861C8F1A28\"><reason code=\"1\">left with request to close if no agents</reason></partyLeft></chatTranscript>', 'text/xml', ' ', 101, 81629431, 1, 701, null, null, '180829-100017', null, null, null, 'https://www-int03.spark.co.nz/help/get-more/xtra-troubleshooting/cant-receive-email/', null, null, null, null, null, null, null, null, null, null, null, null, 'Normal', null, null, null);" +
                "    INSERT INTO INTERACTION (ID, STATUS, ENTITYTYPEID, MEDIATYPEID, TYPEID, SUBTYPEID, EXTERNALID, OWNERID, CONTACTID, PARENTID, STARTDATE, ENDDATE, THREADID, CATEGORYID, TIMESHIFT, SUBJECT, TEXT, STRUCTUREDTEXT, STRUCTTEXTMIMETYPE, THECOMMENT, TENANTID, THREADHASH, CANBEPARENT, CREATORAPPID, QUEUENAME, STRATTRIBUTE1, STRATTRIBUTE2, STRATTRIBUTE3, STRATTRIBUTE4, STRATTRIBUTE5, STRATTRIBUTE6, STRATTRIBUTE7, STRATTRIBUTE8, STRATTRIBUTE9, STRATTRIBUTE10, INTATTRIBUTE1, INTATTRIBUTE2, INTATTRIBUTE3, INTATTRIBUTE4, INTATTRIBUTE5, ISSPAM, WEBSAFEEMAILSTATUS, ISCATEGORYAPPROVED, STOPPEDREASON, LANG, MODIFIEDDATE, SUBTENANTID) VALUES ('00027aDEQEY00TVF', 3, 2, 'facebooksession', 'Inbound', 'InboundNew', '02BD5B8614C51A22', 3159, '00027aDEQEY002TG', null, TIMESTAMP '"+
                less45Min.format(formatter)+"', null, '00027aDEQEY00TVG', null, 0, ' - Spark Ref: 180829-100016', null, '<?xml version=\"1.0\"?><chatTranscript startAt=\"2018-08-29T03:36:37Z\" sessionId=\"00027aDEQEY00TVF\"><newParty userId=\"02BD5B8614C51A21\" timeShift=\"0\" visibility=\"ALL\" eventId=\"1\"><userInfo personId=\"\" userNick=\"Jobin Joseph\" userType=\"CLIENT\" protocolType=\"FLEX\" timeZoneOffset=\"0\"/><userData><item key=\"BroadbandDiagnosticJourney\"></item><item key=\"BroadbandDiagnosticServiceID\"></item><item key=\"ConnectionID\">02c702bea83241f9</item><item key=\"EmailAddress\">jobin.joseph@spark.co.nz</item><item key=\"FirstName\">Jobin</item><item key=\"GCTI_LanguageCode\">en-NZ</item><item key=\"IPaddress\">10.235.8.19</item><item key=\"IdentifyCreateContact\">3</item><item key=\"LastName\">Joseph</item><item key=\"MediaType\">chat</item><item key=\"PageTag\">HelpXtra</item><item key=\"TimeZone\">780</item><item key=\"UserAgent\">Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/68.0.3440.106 Safari/537.36</item><item key=\"VHQueue\"></item><item key=\"_genesys_pageTitle\">Can&apos;t receive email | Spark NZ</item><item key=\"_genesys_referrer\"></item><item key=\"_genesys_source\">web</item><item key=\"_genesys_url\">https://www-int03.spark.co.nz/help/get-more/xtra-troubleshooting/cant-receive-email/</item></userData></newParty><newParty userId=\"02BD5B8614CE1A23\" timeShift=\"9\" visibility=\"ALL\" eventId=\"2\"><userInfo personId=\"\" userNick=\"Spark\" userType=\"EXTERNAL\" protocolType=\"ESP\" timeZoneOffset=\"0\"/></newParty><message userId=\"02BD5B8614CE1A23\" timeShift=\"9\" visibility=\"ALL\" eventId=\"3\"><msgText>Xtra troubleshooting details" +
                "    Question - How are you trying to access your Xtra Mail?" +
                "    Customer chose - I use Webmail (xtramail.co.nz)" +
                "    Question - To see if your account is working, try signing in to Webmail with your email address and password at xtramail.co.nz" +
                "" +
                " " +
                "" +
                "    Did it work?" +
                "    Customer chose - No" +
                "    Question - There may be a problem with your internet connection. On the device you&apos;re trying access your Xtra Mail with, can you open other websites such as google.co.nz?" +
                "    Customer chose - Yes" +
                "    Question - Ah, your internet is working so there may be another problem. What&apos;s happening?" +
                "    Customer chose - Something else is happening." +
                "    Question - There may be an outage, but it hasn&apos;t been reported yet. Or there could be a problem with your modem. What would you like to do?" +
                "    Customer chose - I&apos;d like to contact Spark by Live Chat.</msgText></message><message userId=\"02BD5B8614CE1A23\" timeShift=\"9\" visibility=\"ALL\" eventId=\"4\"><msgText>My email address: jobin.joseph@spark.co.nz</msgText></message><message userId=\"02BD5B8614CE1A23\" timeShift=\"9\" visibility=\"ALL\" eventId=\"5\"><msgText>My question: </msgText></message><message userId=\"02BD5B8614CE1A23\" timeShift=\"9\" visibility=\"ALL\" eventId=\"6\"><msgText>Someone should be available to help you in less than a minute.</msgText></message><newParty userId=\"02BD5B8614D31A24\" timeShift=\"14\" visibility=\"ALL\" eventId=\"7\"><userInfo personId=\"t805645\" userNick=\"Eddie\" userType=\"AGENT\" protocolType=\"BASIC\" timeZoneOffset=\"720\"/></newParty><partyLeft userId=\"02BD5B8614C51A21\" timeShift=\"62\" visibility=\"ALL\" eventId=\"8\" askerId=\"02BD5B8614C51A21\"><reason>left</reason></partyLeft><partyLeft userId=\"02BD5B8614D31A24\" timeShift=\"196\" visibility=\"ALL\" eventId=\"9\" askerId=\"02BD5B8614D31A24\"><reason code=\"1\">left with request to close if no agents</reason></partyLeft></chatTranscript>', 'text/xml', ' ', 101, 81629430, 1, 701, null, null, '180829-100016', null, null, null, 'https://www-int03.spark.co.nz/help/get-more/xtra-troubleshooting/cant-receive-email/', null, null, null, null, null, null, null, null, null, null, null, null, 'Normal', null, null, null);"+
                "    INSERT INTO INTERACTION (ID, STATUS, ENTITYTYPEID, MEDIATYPEID, TYPEID, SUBTYPEID, EXTERNALID, OWNERID, CONTACTID, PARENTID, STARTDATE, ENDDATE, THREADID, CATEGORYID, TIMESHIFT, SUBJECT, TEXT, STRUCTUREDTEXT, STRUCTTEXTMIMETYPE, THECOMMENT, TENANTID, THREADHASH, CANBEPARENT, CREATORAPPID, QUEUENAME, STRATTRIBUTE1, STRATTRIBUTE2, STRATTRIBUTE3, STRATTRIBUTE4, STRATTRIBUTE5, STRATTRIBUTE6, STRATTRIBUTE7, STRATTRIBUTE8, STRATTRIBUTE9, STRATTRIBUTE10, INTATTRIBUTE1, INTATTRIBUTE2, INTATTRIBUTE3, INTATTRIBUTE4, INTATTRIBUTE5, ISSPAM, WEBSAFEEMAILSTATUS, ISCATEGORYAPPROVED, STOPPEDREASON, LANG, MODIFIEDDATE, SUBTENANTID) VALUES ('00027aDEQEY00TYX', 3, 2, 'chat', 'Inbound', 'InboundNew', '02BD5B874F401A58', 3159, '0001CaAV5KUW828W', null, TIMESTAMP '" +
                less1Hour.format(formatter)+"', TIMESTAMP '"+less1Hour.plusMinutes(10).format(formatter)+"', '00027aDEQEY00TYF', null, 720, ' - Spark Ref: 180830-100013', null, '<?xml version=\"1.0\"?><chatTranscript startAt=\"2018-08-30T01:58:24Z\" sessionId=\"00027aDEQEY00TYB\"><newParty userId=\"02BD5B874F401A57\" timeShift=\"0\" visibility=\"ALL\" eventId=\"1\"><userInfo personId=\"\" userNick=\"Spark Customer\" userType=\"CLIENT\" protocolType=\"FLEX\" timeZoneOffset=\"0\"/><userData><item key=\"BroadbandDiagnosticJourney\"></item><item key=\"BroadbandDiagnosticServiceID\"></item><item key=\"ConnectionID\">02c702bea83248ed</item><item key=\"FirstName\">Spark</item><item key=\"GCTI_LanguageCode\">en-NZ</item><item key=\"IPaddress\">10.235.8.19</item><item key=\"IdentifyCreateContact\">3</item><item key=\"LastName\">Customer</item><item key=\"MediaType\">chat</item><item key=\"PageTag\">SparkApp</item><item key=\"TimeZone\">780</item><item key=\"UserAgent\">Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/68.0.3440.106 Safari/537.36</item><item key=\"VHQueue\"></item><item key=\"_genesys_pageTitle\">Chat With Us | Spark NZ</item><item key=\"_genesys_referrer\"></item><item key=\"_genesys_source\">web</item><item key=\"_genesys_url\">https://www-int03.spark.co.nz/help/app-chat/</item></userData></newParty><newParty userId=\"02BD5B7CDBA71995\" timeShift=\"4\" visibility=\"ALL\" eventId=\"2\"><userInfo personId=\"\" userNick=\"Spark&apos;s Virtual Assistant\" userType=\"AGENT\" protocolType=\"BASIC\" timeZoneOffset=\"0\"/></newParty><message userId=\"02BD5B7CDBA71995\" timeShift=\"5\" visibility=\"ALL\" eventId=\"3\"><msgText>Hi there, welcome back! How can I help?</msgText></message><notice userId=\"02BD5B7CDBA71995\" timeShift=\"5\" visibility=\"ALL\" eventId=\"4\"><noticeText noticeType=\"USER_CUSTOM\">Hi there, welcome back! How can I help?</noticeText></notice><message userId=\"02BD5B874F401A57\" timeShift=\"25\" visibility=\"ALL\" eventId=\"9\"><msgText msgType=\"text\">human</msgText></message><message userId=\"02BD5B7CDBA71995\" timeShift=\"27\" visibility=\"ALL\" eventId=\"10\"><msgText>My human colleagues are available to talk to you, they&apos;re really busy at the moment so the wait time may be longer than usual. Select Connect to Live Chat to get started. More Information:" +
                "    Connect to Live Chat</msgText></message><notice userId=\"02BD5B7CDBA71995\" timeShift=\"27\" visibility=\"ALL\" eventId=\"11\"><noticeText noticeType=\"USER_CUSTOM\">My human colleagues are available to talk to you, they&apos;re really busy at the moment so the wait time may be longer than usual. Select Connect to Live Chat to get started.&lt;br&gt;&lt;ul class=&quot;gwc-action-list&quot;&gt;&lt;li class=&quot;gwc-action-item&quot;&gt;&lt;a href=&quot;#&quot; class=&quot;gwc-action-text&quot; id=&quot;6a0c3d32-67cb-48d8-92a4-a1846174bb75&quot;&gt;Connect to Live Chat&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;</noticeText></notice><message userId=\"02BD5B874F401A57\" timeShift=\"35\" visibility=\"ALL\" eventId=\"12\"><msgText msgType=\"text\">Connect to Live Chat</msgText></message><message userId=\"02BD5B7CDBA71995\" timeShift=\"36\" visibility=\"ALL\" eventId=\"13\"><msgText>Someone should be available to help you in less than a minute.</msgText></message><notice userId=\"02BD5B7CDBA71995\" timeShift=\"36\" visibility=\"ALL\" eventId=\"14\"><noticeText noticeType=\"USER_CUSTOM\">Someone should be available to help you in less than a minute.</noticeText></notice><message userId=\"02BD5B7CDBA71995\" timeShift=\"37\" visibility=\"ALL\" eventId=\"15\"><msgText>Before I transfer you, can you please tell me your name?</msgText></message><notice userId=\"02BD5B7CDBA71995\" timeShift=\"37\" visibility=\"ALL\" eventId=\"16\"><noticeText noticeType=\"USER_CUSTOM\">Before I transfer you, can you please tell me your name?</noticeText></notice><message userId=\"02BD5B874F401A57\" timeShift=\"46\" visibility=\"ALL\" eventId=\"18\"><msgText msgType=\"text\">test</msgText></message><message userId=\"02BD5B7CDBA71995\" timeShift=\"46\" visibility=\"ALL\" eventId=\"19\"><msgText>Can I have your email address so I can send you a transcript of our chat?</msgText></message><notice userId=\"02BD5B7CDBA71995\" timeShift=\"46\" visibility=\"ALL\" eventId=\"20\"><noticeText noticeType=\"USER_CUSTOM\">Can I have your email address so I can send you a transcript of our chat?</noticeText></notice><message userId=\"02BD5B874F401A57\" timeShift=\"54\" visibility=\"ALL\" eventId=\"22\"><msgText msgType=\"text\">test@spark.co.nz</msgText></message><partyLeft userId=\"02BD5B7CDBA71995\" timeShift=\"54\" visibility=\"ALL\" eventId=\"23\" askerId=\"02BD5B7CDBA71995\"><reason>left</reason></partyLeft><newParty userId=\"02BD5B874F781A59\" timeShift=\"56\" visibility=\"ALL\" eventId=\"24\"><userInfo personId=\"\" userNick=\"Spark\" userType=\"EXTERNAL\" protocolType=\"ESP\" timeZoneOffset=\"0\"/></newParty><notice userId=\"02BD5B874F781A59\" timeShift=\"56\" visibility=\"ALL\" eventId=\"25\"><noticeText noticeType=\"USER_CUSTOM\">switching from bot to real agent</noticeText></notice><message userId=\"02BD5B874F781A59\" timeShift=\"56\" visibility=\"ALL\" eventId=\"26\"><msgText>*#You&apos;re being transferred to the Live Chat team. We estimate someone should be with you in less than a minute.</msgText></message><newParty userId=\"02BD5B874FA51A5A\" timeShift=\"101\" visibility=\"ALL\" eventId=\"29\"><userInfo personId=\"t805645\" userNick=\"Eddie\" userType=\"AGENT\" protocolType=\"BASIC\" timeZoneOffset=\"720\"/></newParty><partyLeft userId=\"02BD5B874F401A57\" timeShift=\"270\" visibility=\"ALL\" eventId=\"32\" askerId=\"02BD5B874F401A57\"><reason>left</reason></partyLeft><partyLeft userId=\"02BD5B874FA51A5A\" timeShift=\"3966\" visibility=\"ALL\" eventId=\"33\" askerId=\"02BD5B874FA51A5A\"><reason code=\"1\">left with request to close if no agents</reason></partyLeft></chatTranscript>', 'text/xml', ' ', 101, 81629955, 1, 701, null, 'test@spark.co.nz', '180830-100013', null, null, null, 'https://www-int03.spark.co.nz/help/app-chat/', null, null, null, null, null, null, null, null, null, null, null, null, 'Normal', null, null, null);"+
                "    INSERT INTO INTERACTION (ID, STATUS, ENTITYTYPEID, MEDIATYPEID, TYPEID, SUBTYPEID, EXTERNALID, OWNERID, CONTACTID, PARENTID, STARTDATE, ENDDATE, THREADID, CATEGORYID, TIMESHIFT, SUBJECT, TEXT, STRUCTUREDTEXT, STRUCTTEXTMIMETYPE, THECOMMENT, TENANTID, THREADHASH, CANBEPARENT, CREATORAPPID, QUEUENAME, STRATTRIBUTE1, STRATTRIBUTE2, STRATTRIBUTE3, STRATTRIBUTE4, STRATTRIBUTE5, STRATTRIBUTE6, STRATTRIBUTE7, STRATTRIBUTE8, STRATTRIBUTE9, STRATTRIBUTE10, INTATTRIBUTE1, INTATTRIBUTE2, INTATTRIBUTE3, INTATTRIBUTE4, INTATTRIBUTE5, ISSPAM, WEBSAFEEMAILSTATUS, ISCATEGORYAPPROVED, STOPPEDREASON, LANG, MODIFIEDDATE, SUBTENANTID) VALUES ('00027aDEQEY00TYF', 3, 2, 'chat', 'Inbound', 'InboundNew', '02BD5B874F401A58', 3159, '0001CaAV5KUW828W', null, TIMESTAMP '"+
                less1Day.format(formatter)+"', TIMESTAMP '"+less1Day.plusMinutes(10).format(formatter)+"', '00027aDEQEY00TYF', null, 720, ' - Spark Ref: 180830-100013', null, '<?xml version=\"1.0\"?><chatTranscript startAt=\"2018-08-30T01:58:24Z\" sessionId=\"00027aDEQEY00TYD\"><newParty userId=\"02BD5B874F401A57\" timeShift=\"0\" visibility=\"ALL\" eventId=\"1\"><userInfo personId=\"\" userNick=\"Spark Customer\" userType=\"CLIENT\" protocolType=\"FLEX\" timeZoneOffset=\"0\"/><userData><item key=\"BroadbandDiagnosticJourney\"></item><item key=\"BroadbandDiagnosticServiceID\"></item><item key=\"ConnectionID\">02c702bea83248ed</item><item key=\"FirstName\">Spark</item><item key=\"GCTI_LanguageCode\">en-NZ</item><item key=\"IPaddress\">10.235.8.19</item><item key=\"IdentifyCreateContact\">3</item><item key=\"LastName\">Customer</item><item key=\"MediaType\">chat</item><item key=\"PageTag\">SparkApp</item><item key=\"TimeZone\">780</item><item key=\"UserAgent\">Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/68.0.3440.106 Safari/537.36</item><item key=\"VHQueue\"></item><item key=\"_genesys_pageTitle\">Chat With Us | Spark NZ</item><item key=\"_genesys_referrer\"></item><item key=\"_genesys_source\">web</item><item key=\"_genesys_url\">https://www-int03.spark.co.nz/help/app-chat/</item></userData></newParty><newParty userId=\"02BD5B7CDBA71995\" timeShift=\"4\" visibility=\"ALL\" eventId=\"2\"><userInfo personId=\"\" userNick=\"Spark&apos;s Virtual Assistant\" userType=\"AGENT\" protocolType=\"BASIC\" timeZoneOffset=\"0\"/></newParty><message userId=\"02BD5B7CDBA71995\" timeShift=\"5\" visibility=\"ALL\" eventId=\"3\"><msgText>Hi there, welcome back! How can I help?</msgText></message><notice userId=\"02BD5B7CDBA71995\" timeShift=\"5\" visibility=\"ALL\" eventId=\"4\"><noticeText noticeType=\"USER_CUSTOM\">Hi there, welcome back! How can I help?</noticeText></notice><message userId=\"02BD5B874F401A57\" timeShift=\"25\" visibility=\"ALL\" eventId=\"9\"><msgText msgType=\"text\">human</msgText></message><message userId=\"02BD5B7CDBA71995\" timeShift=\"27\" visibility=\"ALL\" eventId=\"10\"><msgText>My human colleagues are available to talk to you, they&apos;re really busy at the moment so the wait time may be longer than usual. Select Connect to Live Chat to get started. More Information:" +
                "    Connect to Live Chat</msgText></message><notice userId=\"02BD5B7CDBA71995\" timeShift=\"27\" visibility=\"ALL\" eventId=\"11\"><noticeText noticeType=\"USER_CUSTOM\">My human colleagues are available to talk to you, they&apos;re really busy at the moment so the wait time may be longer than usual. Select Connect to Live Chat to get started.&lt;br&gt;&lt;ul class=&quot;gwc-action-list&quot;&gt;&lt;li class=&quot;gwc-action-item&quot;&gt;&lt;a href=&quot;#&quot; class=&quot;gwc-action-text&quot; id=&quot;6a0c3d32-67cb-48d8-92a4-a1846174bb75&quot;&gt;Connect to Live Chat&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;</noticeText></notice><message userId=\"02BD5B874F401A57\" timeShift=\"35\" visibility=\"ALL\" eventId=\"12\"><msgText msgType=\"text\">Connect to Live Chat</msgText></message><message userId=\"02BD5B7CDBA71995\" timeShift=\"36\" visibility=\"ALL\" eventId=\"13\"><msgText>Someone should be available to help you in less than a minute.</msgText></message><notice userId=\"02BD5B7CDBA71995\" timeShift=\"36\" visibility=\"ALL\" eventId=\"14\"><noticeText noticeType=\"USER_CUSTOM\">Someone should be available to help you in less than a minute.</noticeText></notice><message userId=\"02BD5B7CDBA71995\" timeShift=\"37\" visibility=\"ALL\" eventId=\"15\"><msgText>Before I transfer you, can you please tell me your name?</msgText></message><notice userId=\"02BD5B7CDBA71995\" timeShift=\"37\" visibility=\"ALL\" eventId=\"16\"><noticeText noticeType=\"USER_CUSTOM\">Before I transfer you, can you please tell me your name?</noticeText></notice><message userId=\"02BD5B874F401A57\" timeShift=\"46\" visibility=\"ALL\" eventId=\"18\"><msgText msgType=\"text\">test</msgText></message><message userId=\"02BD5B7CDBA71995\" timeShift=\"46\" visibility=\"ALL\" eventId=\"19\"><msgText>Can I have your email address so I can send you a transcript of our chat?</msgText></message><notice userId=\"02BD5B7CDBA71995\" timeShift=\"46\" visibility=\"ALL\" eventId=\"20\"><noticeText noticeType=\"USER_CUSTOM\">Can I have your email address so I can send you a transcript of our chat?</noticeText></notice><message userId=\"02BD5B874F401A57\" timeShift=\"54\" visibility=\"ALL\" eventId=\"22\"><msgText msgType=\"text\">test@spark.co.nz</msgText></message><partyLeft userId=\"02BD5B7CDBA71995\" timeShift=\"54\" visibility=\"ALL\" eventId=\"23\" askerId=\"02BD5B7CDBA71995\"><reason>left</reason></partyLeft><newParty userId=\"02BD5B874F781A59\" timeShift=\"56\" visibility=\"ALL\" eventId=\"24\"><userInfo personId=\"\" userNick=\"Spark\" userType=\"EXTERNAL\" protocolType=\"ESP\" timeZoneOffset=\"0\"/></newParty><notice userId=\"02BD5B874F781A59\" timeShift=\"56\" visibility=\"ALL\" eventId=\"25\"><noticeText noticeType=\"USER_CUSTOM\">switching from bot to real agent</noticeText></notice><message userId=\"02BD5B874F781A59\" timeShift=\"56\" visibility=\"ALL\" eventId=\"26\"><msgText>*#You&apos;re being transferred to the Live Chat team. We estimate someone should be with you in less than a minute.</msgText></message><newParty userId=\"02BD5B874FA51A5A\" timeShift=\"101\" visibility=\"ALL\" eventId=\"29\"><userInfo personId=\"t805645\" userNick=\"Eddie\" userType=\"AGENT\" protocolType=\"BASIC\" timeZoneOffset=\"720\"/></newParty><partyLeft userId=\"02BD5B874F401A57\" timeShift=\"270\" visibility=\"ALL\" eventId=\"32\" askerId=\"02BD5B874F401A57\"><reason>left</reason></partyLeft><partyLeft userId=\"02BD5B874FA51A5A\" timeShift=\"3966\" visibility=\"ALL\" eventId=\"33\" askerId=\"02BD5B874FA51A5A\"><reason code=\"1\">left with request to close if no agents</reason></partyLeft></chatTranscript>', 'text/xml', ' ', 101, 81629955, 1, 701, null, 'test@spark.co.nz', '180830-100013', null, null, null, 'https://www-int03.spark.co.nz/help/app-chat/', null, null, null, null, null, null, null, null, null, null, null, null, 'Normal', null, null, null);";
    }

    private Connection createLocalDB() throws SQLException, ClassNotFoundException {
        Connection connection;
        Statement statement;

        connection = SQLUtils.getDBConnection(
            SocialExtractorTimer.configMap.get("database.local.driver"),
            SocialExtractorTimer.configMap.get("database.local.url"),
            SocialExtractorTimer.configMap.get("database.local.user"),
            SocialExtractorTimer.configMap.get("database.local.password")
        );
        connection.setAutoCommit(true);
        statement = connection.createStatement();
        statement.execute("CREATE SEQUENCE IF NOT EXISTS INTERACTION_SEQ;");
        statement.execute("CREATE TABLE IF NOT EXISTS interaction(id CHAR(18),sequence BIGINT DEFAULT INTERACTION_SEQ.NEXTVAL,type CHAR(20),startdate TIMESTAMP,enddate TIMESTAMP,timeshift INT DEFAULT 0,xml CLOB, finished BOOLEAN DEFAULT false, PRIMARY KEY(ID,type));");
        statement.execute("CREATE TABLE IF NOT EXISTS token(api CHAR(20) PRIMARY KEY,retrievaldate TIMESTAMP,expirationdate TIMESTAMP,accesstoken VARCHAR(128),refreshtoken VARCHAR(128));");
        statement.execute("CREATE INDEX IF NOT EXISTS date_index_interaction ON interaction(startdate);");
        statement.execute("CREATE INDEX IF NOT EXISTS seq_index_interaction ON interaction(sequence);");
        return connection;
    }

    @After
    public void tearDown() {
        try {
            XmlDomUtils.removeXML(new File(SocialExtractorTimer.configMap.get("output.directory")));

            if( remoteMemConnection != null ) {
                remoteMemConnection.close();
            }
            if( localMemConnection != null ) {
                localMemConnection.close();
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
    }
}